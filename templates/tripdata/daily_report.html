<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daily Trip Report</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1, h2 { text-align: center; }
    table { border-collapse: collapse; width: 95%; margin: 20px auto; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background-color: #f0f0f0; }
    tfoot tr { font-weight: bold; background-color: #dfe6e9; }
    .chart-container { width: 95%; max-width: 1200px; margin: 30px auto; }
    .note { text-align: center; color: #555; font-size: 0.9em; margin-top: 10px; }
    .filter-container { width: 800px; margin: 10px auto; text-align: center; }
    .filter-container select { margin: 0 10px; }
    canvas { background: #fff; border: 1px solid #ddd; border-radius: 6px; }
</style>
</head>
<body>
<h1>ðŸ“Š Daily Trip Report</h1>

{% if error %}
<p style="color: red; text-align:center;">{{ error }}</p>
{% else %}

<div class="filter-container">
    <label for="carTypeSelect">Car Type:</label>
    <select id="carTypeSelect">
        <option value="All">All</option>
        {% for ct in chart_car_types %}
            <option value="{{ ct }}">{{ ct }}</option>
        {% endfor %}
    </select>

    <label for="ageTypeSelect">Customer Age Type:</label>
    <select id="ageTypeSelect">
        <option value="All">All</option>
        <option value="New Customer">New Customer</option>
        <option value="Old Customer">Old Customer</option>
    </select>

    <label for="repeatTypeSelect">Repetition Type:</label>
    <select id="repeatTypeSelect">
        <option value="All">All</option>
        <option value="Repeat">Repeat</option>
        <option value="Non-Repeat">Non-Repeat</option>
    </select>

    <button id="resetWeekday">Reset Weekday Filter</button>
</div>

<div class="chart-container">
    <canvas id="tripChart"></canvas>
</div>

<p class="note">
ðŸ’¡ You can filter by Car Type, Customer Age Type, and Repetition Type using the dropdowns.<br>
ðŸ’¡ Click a weekday label in the chart to filter that weekday. Use "Reset Weekday Filter" to show all days.
</p>

<!-- Chart Table -->
<h2>ðŸ“‹ Day Wise (Trip - Filterable)</h2>
<table id="chartDataTable">
    <thead>
        <tr>
            <th>Date (Weekday)</th>
            <th>Total Trip Request</th>
            <th>Confirmed Trips</th>
            <th>Non-Confirmed Trips</th>
            <th>Completed Trips</th>
            <th>Cancelled From Confirmed</th>
            <th>Zero Bid Trips</th>
        </tr>
    </thead>
    <tbody id="chartTableBody"></tbody>
    <tfoot>
        <tr id="chartTableTotal">
            <td>TOTAL</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
            <td>0</td>
        </tr>
    </tfoot>
</table>

<!-- Original Summary Table -->
<h2>ðŸ“‹ Day Wise (Trip - All Car)</h2>
<table>
    <thead>
        <tr>
            <th>Date (Weekday)</th>
            <th>Total Trip Request</th>
            <th>Confirmed</th>
            <th>Non-Confirmed</th>
            <th>Trip Still Confirmed</th>
            <th>Completed</th>
            <th>Cancelled From Confirmed</th>
            <th>Cancelled By Customer</th>
            <th>Cancelled By Driver</th>
            <th>Zero Bid</th>
        </tr>
    </thead>
    <tbody>
    {% for day in daily_rows %}
        {% if day.date == 'TOTAL' %}
            </tbody>
            <tfoot>
            <tr>
                <td>{{ day.date }}</td>
                <td>{{ day.total }}</td>
                <td>{{ day.confirmed }}</td>
                <td>{{ day.non_confirmed }}</td>
                <td>{{ day.trip_still_confirmed }}</td>
                <td>{{ day.completed }}</td>
                <td>{{ day.cancelled_from_confirmed }}</td>
                <td>{{ day.cancelled_by_customer }}</td>
                <td>{{ day.cancelled_by_driver }}</td>
                <td>{{ day.zero_bid }}</td>
            </tr>
            </tfoot>
        {% else %}
            <tr>
                <td>{{ day.date }}</td>
                <td>{{ day.total }}</td>
                <td>{{ day.confirmed }}</td>
                <td>{{ day.non_confirmed }}</td>
                <td>{{ day.trip_still_confirmed }}</td>
                <td>{{ day.completed }}</td>
                <td>{{ day.cancelled_from_confirmed }}</td>
                <td>{{ day.cancelled_by_customer }}</td>
                <td>{{ day.cancelled_by_driver }}</td>
                <td>{{ day.zero_bid }}</td>
            </tr>
        {% endif %}
    {% endfor %}
    </tbody>
</table>

<script>
const chartData = JSON.parse('{{ chart_json|escapejs }}');

// Get filter elements
const carTypeSelect = document.getElementById('carTypeSelect');
const ageTypeSelect = document.getElementById('ageTypeSelect');
const repeatTypeSelect = document.getElementById('repeatTypeSelect');

// Pickup Division filter dropdown (make sure it's in your HTML)
const pickupDivSelect = document.createElement('select');
pickupDivSelect.id = 'pickupDivSelect';
pickupDivSelect.style.marginLeft = '10px';
pickupDivSelect.innerHTML = '<option value="All">All Pickup Div</option>' +
    `{% for pd in pickup_divs %}<option value="{{ pd }}">{{ pd }}</option>{% endfor %}`;
document.querySelector('.filter-container').appendChild(pickupDivSelect);

// Initialize chart datasets
const baseDatasets = [
    { label:'Total Trip Request', data: chartData.series.total.slice(), type:'bar', backgroundColor:'rgba(54,162,235,0.5)', borderColor:'rgba(54,162,235,1)', borderWidth:1 },
    { label:'Confirmed Trips', data: chartData.series.confirmed.slice(), type:'line', borderColor:'rgba(255,99,132,1)', fill:false, tension:0.3, borderWidth:2 },
    { label:'Non-Confirmed Trips', data: chartData.series.non_confirmed.slice(), type:'line', borderColor:'rgba(255,159,64,1)', fill:false, tension:0.3, borderWidth:2 },
    { label:'Completed Trips', data: chartData.series.completed.slice(), type:'line', borderColor:'rgba(75,192,192,1)', fill:false, tension:0.3, borderWidth:2 },
    { label:'Cancelled From Confirmed', data: chartData.series.cancelled_from_confirmed.slice(), type:'line', borderColor:'rgba(255,206,86,1)', fill:false, tension:0.3, borderWidth:2 },
    { label:'Zero Bid Trips', data: chartData.series.zero_bid.slice(), type:'line', borderColor:'rgba(153,102,255,1)', fill:false, tension:0.3, borderWidth:2 }
];

// Create Chart
const ctx = document.getElementById('tripChart').getContext('2d');
const chart = new Chart(ctx, {
    type:'bar',
    data:{ labels: chartData.labels.slice(), datasets: baseDatasets },
    options:{
        responsive:true,
        interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{ position:'top' }, title:{ display:true, text:'Trips Overview by Weekday' } },
        scales:{ x:{ title:{ display:true, text:'Date (Weekday)' } }, y:{ beginAtZero:true, title:{ display:true, text:'Trips Count' } } }
    }
});

// Apply all filters
function applyFilters() {
    const carType = carTypeSelect.value;
    const ageType = ageTypeSelect.value;
    const repeatType = repeatTypeSelect.value;
    const pickupDiv = pickupDivSelect.value;

    const metrics = ['total','confirmed','non_confirmed','completed','cancelled_from_confirmed','zero_bid'];
    const datasetMap = {
        'total': 0, 'confirmed': 1, 'non_confirmed': 2,
        'completed': 3, 'cancelled_from_confirmed': 4, 'zero_bid': 5
    };

    chart.data.datasets.forEach(ds=>{
        const metric = Object.keys(datasetMap).find(k=>datasetMap[k] === chart.data.datasets.indexOf(ds));
        let dataArray;

        if (carType === 'All' && ageType === 'All' && repeatType === 'All' && pickupDiv === 'All') {
            dataArray = chartData.series[metric].slice();
        } else {
            const ctKey = carType === 'All' ? 'All' : carType;
            const ageKey = ageType === 'All' ? 'All' : (ageType === 'New Customer' ? 'New' : 'Old');
            const repeatKey = repeatType === 'All' ? 'All' : repeatType;
            const pdKey = pickupDiv === 'All' ? 'All' : pickupDiv;

            // Safe access with fallback
            dataArray = chartData.breakdown[metric]?.[ctKey]?.[ageKey]?.[repeatKey]?.[pdKey] || Array(chartData.labels.length).fill(0);
        }

        ds.data = dataArray.slice();
    });

    chart.update();
    updateChartTable();
}

// Populate chart table
function updateChartTable() {
    const tbody = document.getElementById('chartTableBody');
    const tfoot = document.getElementById('chartTableTotal');
    tbody.innerHTML = '';

    const totals = { total:0, confirmed:0, non_confirmed:0, completed:0, cancelled:0, zero_bid:0 };

    chart.data.labels.forEach((label, i)=>{
        const total = chart.data.datasets[0].data[i] || 0;
        const confirmed = chart.data.datasets[1].data[i] || 0;
        const nonConfirmed = chart.data.datasets[2].data[i] || 0;
        const completed = chart.data.datasets[3].data[i] || 0;
        const cancelled = chart.data.datasets[4].data[i] || 0;
        const zeroBid = chart.data.datasets[5].data[i] || 0;

        totals.total += total;
        totals.confirmed += confirmed;
        totals.non_confirmed += nonConfirmed;
        totals.completed += completed;
        totals.cancelled += cancelled;
        totals.zero_bid += zeroBid;

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${label}</td><td>${total}</td><td>${confirmed}</td><td>${nonConfirmed}</td><td>${completed}</td><td>${cancelled}</td><td>${zeroBid}</td>`;
        tbody.appendChild(tr);
    });

    tfoot.cells[1].textContent = totals.total;
    tfoot.cells[2].textContent = totals.confirmed;
    tfoot.cells[3].textContent = totals.non_confirmed;
    tfoot.cells[4].textContent = totals.completed;
    tfoot.cells[5].textContent = totals.cancelled;
    tfoot.cells[6].textContent = totals.zero_bid;
}

// Listeners
carTypeSelect.addEventListener('change', applyFilters);
ageTypeSelect.addEventListener('change', applyFilters);
repeatTypeSelect.addEventListener('change', applyFilters);
pickupDivSelect.addEventListener('change', applyFilters);

// Weekday click filtering
chart.options.onClick = (e, elements)=>{
    if(!elements.length) return;
    const idx = elements[0].index;
    const wd = chartData.labels[idx].split(',')[0];
    const indices = chartData.labels.map((l,i)=> l.startsWith(wd)?i:-1).filter(i=>i>=0);

    chart.data.labels = indices.map(i=> chartData.labels[i]);
    chart.data.datasets.forEach(ds=> ds.data = indices.map((_,i)=> ds.data[i]));
    chart.update();
    updateChartTable();
};

// Reset Weekday Filter
document.getElementById('resetWeekday').addEventListener('click', ()=>{
    chart.data.labels = chartData.labels.slice();
    applyFilters();
});

// Initial render
applyFilters();
</script>



{% endif %}
</body>
</html>
